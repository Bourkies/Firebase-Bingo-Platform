rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- NEW: Role-based helper functions ---
    function isAuth() {
      return request.auth != null;
    }
    function userPath() {
      return /databases/$(database)/documents/users/$(request.auth.token.email);
    }
    function getUserData() {
      // UPDATED: Fetch user data using Email as Document ID, matching Architecture.md
      return get(userPath()).data;
    }
    function isAdmin() {
      // Use .get() for safety, matching the storage rule. This ensures it handles missing fields gracefully.
      return isAuth() && exists(userPath()) && getUserData().get('isAdmin', false) == true;
    }
    function isEventMod() {
      return isAuth() && exists(userPath()) && (getUserData().get('isEventMod', false) == true || isAdmin());
    }
    function isCaptainOfTeam(teamName) {
      // A captain is defined by the captainId field in a document in the /teams collection.
      // Return false if teamId is null or not a string.
      return isAuth() && teamName != null && teamName is string &&
             get(/databases/$(database)/documents/teams/$(teamName)).data.captainId == request.auth.uid;
    }
    
    function isCensored() {
      return exists(/databases/$(database)/documents/config/main) && 
             get(/databases/$(database)/documents/config/main).data.get('censorTilesBeforeEvent', false) == true;
    }

    // Config and Tiles are publicly readable, but only Admins can modify them via the setup page.
    match /config/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /tiles/{tileId} {
      // Allow read if censorship is off, OR if the user is an admin/mod.
      // If censorship is on, non-admins will be denied and should read from `config/tiles_packed_public`.
      allow read: if !isCensored() || isEventMod();
      allow write: if isAdmin();
    }

    // NEW: Teams are publicly readable, but only Admins can modify them.
    // This rule is required to create, update, or delete team documents from the setup page.
    match /teams/{teamId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // NEW: Styles are publicly readable, but only Admins can modify them.
    match /styles/{styleId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /submissions/{subId} {
      // Read is allowed if:
      // 1. The board is not private, OR
      // 2. The user is an Event Mod/Admin, OR
      // 3. The user is logged in and requesting a submission for their own team.
      allow read: if get(/databases/$(database)/documents/config/main).data.boardVisibility != 'private' ||
                     isEventMod() || (isAuth() && getUserData().team == resource.data.Team);

      // A logged-in user can create a submission, but only for their own team.
      allow create: if request.auth != null &&
                      getUserData().team == request.resource.data.Team;

      // An update is allowed if you are an Event Mod, OR
      // if you are on the submission's team AND you are not changing the team field.
      allow update: if isAuth() &&
                      ( isEventMod() ||
                        (getUserData().team == resource.data.Team &&
                         request.resource.data.Team == resource.data.Team) );

      allow delete: if isEventMod();
    }

    match /users/{userEmail} {
      // Read is allowed if:
      // 1. You are an admin/mod (can read/list anyone).
      // 2. You are reading your own profile.
      // 3. You are reading the profile of a teammate.
      allow read: if isEventMod() || // Admins/Mods can read anyone.
                     (isAuth() && request.auth.token.email == userEmail) || // Users can read their own profile (Doc ID is Email).
                     (isAuth() && getUserData().team != null && getUserData().team == resource.data.team) || // Users can read teammate profiles.
                     (isAuth() && isCaptainOfTeam(getUserData().team)); // Captains can read any user profile.
      
      // FIX: Add a 'list' rule to allow a user to query for their teammates.
      // This is what allows the `where('team', '==', ...)` query to succeed for non-admins.
      // A captain can also list users with no team (`team == null`).
      allow list: if isEventMod() || // Admins/Mods can list anyone.
                     // A captain can list all users. Write access is still restricted by the update rule.
                     (isAuth() && isCaptainOfTeam(getUserData().team)) ||
                     // Any authenticated user can list their own teammates.
                     (isAuth() && request.query.where.team == getUserData().team);

      allow create: if request.auth.token.email == userEmail; // A user can create their own profile on first sign-in.

      // Update is allowed if:
      allow update: if
        // 1. You are an Admin (can change anything).
        isAdmin() ||
        // 2. You are an Event Mod (can change anything except making someone an admin).
        (isEventMod() && request.resource.data.isAdmin == resource.data.isAdmin) ||
        // 3. You are a Captain changing ONLY the 'team' field of a user you are captain of.
        (
          (isCaptainOfTeam(resource.data.team) || isCaptainOfTeam(request.resource.data.team)) &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['team'])
        ) ||
        // 4. You are updating your OWN profile, under specific conditions.
        (
          request.auth.token.email == userEmail &&
          // You cannot make yourself an admin or mod.
          request.resource.data.get('isAdmin', false) == resource.data.get('isAdmin', false) &&
          request.resource.data.get('isEventMod', false) == resource.data.get('isEventMod', false) &&
          // You can only change your displayName (if not locked), hasSetDisplayName flag, and backfill your email.
          (resource.data.get('isNameLocked', false) == false || request.resource.data.displayName == resource.data.displayName) &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['displayName', 'hasSetDisplayName', 'email'])
        );

      // Admin can delete users (e.g. for cleanup/seeding).
      allow delete: if isAdmin();
    }
  }
}