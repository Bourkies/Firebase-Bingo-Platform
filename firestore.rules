rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- NEW: Role-based helper functions ---
    function isAuth() {
      return request.auth != null;
    }
    function userPath() {
      return /databases/$(database)/documents/users/$(request.auth.token.email);
    }
    function getUserData() {
      // UPDATED: Fetch user data using Email as Document ID, matching Architecture.md
      return get(userPath()).data;
    }
    function isAdmin() {
      // Use .get() for safety, matching the storage rule. This ensures it handles missing fields gracefully.
      return isAuth() && exists(userPath()) && getUserData().get('isAdmin', false) == true;
    }
    function isEventMod() {
      return isAuth() && exists(userPath()) && (getUserData().get('isEventMod', false) == true || isAdmin());
    }
    function isCaptainOfTeam(teamName) {
      // A captain is defined by the captainId field in a document in the /teams collection.
      // Return false if teamId is null or not a string.
      return isAuth() && teamName != null && teamName is string &&
             get(/databases/$(database)/documents/teams/$(teamName)).data.captainId == request.auth.uid;
    }
    
    function isCensored() {
      return exists(/databases/$(database)/documents/config/main) && 
             get(/databases/$(database)/documents/config/main).data.get('censorTilesBeforeEvent', false) == true;
    }
    function isSetupMode() {
      return exists(/databases/$(database)/documents/config/main) && 
             get(/databases/$(database)/documents/config/main).data.get('setupModeEnabled', false) == true;
    }

    // Config and Tiles are publicly readable, but only Admins can modify them via the setup page.
    match /config/{docId} {
      // UPDATED: Hide config (including board image) from non-admins when in Setup Mode.
      allow read: if isAdmin() || !isSetupMode();
      allow write: if isAdmin();
    }
    match /tiles/{tileId} {
      // UPDATED: If Setup Mode is on, ONLY Admins can read.
      // Otherwise, revert to standard censorship logic.
      allow read: if isAdmin() || (!isSetupMode() && (!isCensored() || isEventMod()));
      allow write: if isAdmin();
    }

    // NEW: Teams are publicly readable, but only Admins can modify them.
    // This rule is required to create, update, or delete team documents from the setup page.
    match /teams/{teamId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // NEW: Styles are publicly readable, but only Admins can modify them.
    match /styles/{styleId} {
      // UPDATED: Hide styles in setup mode.
      allow read: if isAdmin() || !isSetupMode();
      allow write: if isAdmin();
    }

    match /submissions/{subId} {
      // Read is allowed if:
      // 1. Setup Mode is OFF (or user is Admin), AND
      // 2. The board is not private, OR
      // 2. The user is an Event Mod/Admin, OR
      // 3. The user is logged in and requesting a submission for their own team.
      allow read: if isAdmin() || (
                     !isSetupMode() && (
                       get(/databases/$(database)/documents/config/main).data.boardVisibility != 'private' ||
                       isEventMod() || (isAuth() && getUserData().team == resource.data.Team)
                     )
                   );

      // A logged-in user can create a submission, but only for their own team.
      allow create: if request.auth != null &&
                      getUserData().team == request.resource.data.Team;

      // An update is allowed if you are an Event Mod, OR
      // if you are on the submission's team AND you are not changing the team field.
      allow update: if isAuth() &&
                      ( isEventMod() ||
                        (getUserData().team == resource.data.Team &&
                         request.resource.data.Team == resource.data.Team) );

      allow delete: if isEventMod();
    }

    match /users/{userEmail} {
      // UPDATED: Allow any authenticated user to read/list user profiles.
      // This is required for the public scoreboard to resolve player names from UIDs/Emails.
      allow read: if isAuth();

      allow create: if request.auth.token.email == userEmail; // A user can create their own profile on first sign-in.

      // Update is allowed if:
      allow update: if
        // 1. You are an Admin (can change anything).
        isAdmin() ||
        // 2. You are an Event Mod (can change anything except making someone an admin).
        (isEventMod() && request.resource.data.isAdmin == resource.data.isAdmin) ||
        // 3. You are a Captain changing ONLY the 'team' field of a user you are captain of.
        (
          (isCaptainOfTeam(resource.data.team) || isCaptainOfTeam(request.resource.data.team)) &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['team'])
        ) ||
        // 4. You are updating your OWN profile, under specific conditions.
        (
          request.auth.token.email == userEmail &&
          // You cannot make yourself an admin or mod.
          request.resource.data.get('isAdmin', false) == resource.data.get('isAdmin', false) &&
          request.resource.data.get('isEventMod', false) == resource.data.get('isEventMod', false) &&
          // You can only change your displayName (if not locked), hasSetDisplayName flag, and backfill your email.
          (resource.data.get('isNameLocked', false) == false || request.resource.data.displayName == resource.data.displayName) &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['displayName', 'hasSetDisplayName', 'email'])
        );

      // Admin can delete users (e.g. for cleanup/seeding).
      allow delete: if isAdmin();
    }
  }
}